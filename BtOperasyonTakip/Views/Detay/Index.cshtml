@model IEnumerable<BtOperasyonTakip.Models.Musteri>
@{
    ViewData["Title"] = "Görüşme Detayları";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/datetime/1.5.2/css/dataTables.dateTime.min.css" />

<style>
    #musteriTable_wrapper {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    #musteriTable {
        width: 100% !important;
        font-size: 0.9rem;
    }

        #musteriTable th {
            background-color: #f8f9fa;
            font-weight: 600;
            white-space: nowrap;
        }

        #musteriTable td {
            vertical-align: middle;
        }

    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }

    .dataTables_filter input {
        border: 1px solid #ddd !important;
        border-radius: 4px !important;
        padding: 6px 12px !important;
        margin-left: 10px !important;
    }

    .dataTables_filter label {
        font-weight: 600;
        padding: 4px;
    }
</style>


<div class="container-fluid mt-4">
    <h2 class="text-primary mb-3">📋 Görüşme Detayları</h2>

    <!-- FİLTRE -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-end">

                <div class="col-md-3">
                    <label class="form-label">Durum</label>
                    <select id="filterDurum" class="form-select">
                        <option value="">Tümü</option>
                        <option value="Aktif">Aktif</option>
                        <option value="Pasif">Pasif</option>
                        <option value="Beklemede">Beklemede</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Teknoloji</label>
                    <select id="filterTeknoloji" class="form-select">
                        <option value="">Tümü</option>
                        @foreach (var tech in Model.Select(m => m.Teknoloji).Distinct().Where(x => !string.IsNullOrEmpty(x)))
                        {
                            <option value="@tech">@tech</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Talep Sahibi</label>
                    <select id="filterTalep" class="form-select">
                        <option value="">Tümü</option>
                        @foreach (var talep in Model.Select(m => m.TalepSahibi).Distinct().Where(x => !string.IsNullOrEmpty(x)))
                        {
                            <option value="@talep">@talep</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Tarih Aralığı</label>
                    <div class="input-group">
                        <input type="text" id="minDate" class="form-control" placeholder="Başlangıç" />
                        <input type="text" id="maxDate" class="form-control" placeholder="Bitiş" />
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- TABLO -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="musteriTable" class="table table-striped table-hover table-bordered mb-0">
                    <thead class="table-secondary">
                        <tr>
                            <th>ID</th>
                            <th>Firma</th>
                            <th>Yetkili</th>
                            <th>Telefon</th>
                            <th>Site URL</th>
                            <th>Teknoloji</th>
                            <th>Durum</th>
                            <th>Talep Sahibi</th>
                            <th>Kayıt Tarihi</th>
                            <th>Açıklama</th>
                            <th width="100">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var m in Model.OrderByDescending(m => m.KayitTarihi))
                        {
                            <tr data-id="@m.MusteriID" style="cursor:pointer;">
                                <td>@m.MusteriID</td>
                                <td class="fw-bold">@m.Firma</td>
                                <td>@m.FirmaYetkilisi</td>
                                <td>@m.Telefon</td>

                                <td>
                                    @if (!string.IsNullOrEmpty(m.SiteUrl))
                                    {
                                        <a href="@m.SiteUrl" target="_blank" onclick="event.stopPropagation()">🔗 Site</a>
                                    }
                                </td>

                                <td><span class="badge bg-info">@m.Teknoloji</span></td>

                                <td>
                                    @{
                                        var cls = m.Durum switch
                                        {
                                            "Aktif" => "bg-success",
                                            "Pasif" => "bg-danger",
                                            "Beklemede" => "bg-warning",
                                            _ => "bg-secondary"
                                        };
                                    }
                                    <span class="badge @cls">@m.Durum</span>
                                </td>

                                <td>@m.TalepSahibi</td>

                                <td>@(m.KayitTarihi?.ToString("dd.MM.yyyy") ?? "-")</td>

                                <td class="text-truncate" style="max-width:200px;" title="@m.Aciklama">
                                    @m.Aciklama
                                </td>

                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-warning edit-btn">✏️</button>
                                        <button class="btn btn-outline-danger delete-btn">❌</button>
                                    </div>
                                </td>

                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="selectedInfo" class="alert alert-info mt-3" style="display:none;"></div>
    <div id="detayContainer" class="mt-3"></div>
</div>


<!-- MODAL -->
<div class="modal fade" id="editMusteriModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">

            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">✏️ Müşteri Düzenle</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="editMusteriForm">
                <div class="modal-body">

                    <input type="hidden" id="editMusteriId" name="MusteriID" />

                    <div class="row g-3">

                        <div class="col-md-6">
                            <label class="form-label">Firma Adı *</label>
                            <input type="text" id="editFirma" name="Firma" class="form-control" required />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Firma Yetkilisi</label>
                            <input type="text" id="editFirmaYetkilisi" name="FirmaYetkilisi" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Telefon</label>
                            <input type="text" id="editTelefon" name="Telefon" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Site URL</label>
                            <input type="text" id="editSiteUrl" name="SiteUrl" class="form-control" />
                        </div>


                        <div class="col-md-6">
                            <label class="form-label">Teknoloji</label>
                            <input type="text" id="editTeknoloji" name="Teknoloji" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Durum *</label>
                            <select id="editDurum" name="Durum" class="form-select" required>
                                <option value="">Seçiniz</option>
                                <option value="Aktif">Aktif</option>
                                <option value="Pasif">Pasif</option>
                                <option value="Beklemede">Beklemede</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Talep Sahibi</label>
                            <input type="text" id="editTalepSahibi" name="TalepSahibi" class="form-control" />
                        </div>

                        <div class="col-12">
                            <label class="form-label">Açıklama</label>
                            <textarea id="editAciklama" name="Aciklama" class="form-control" rows="4"></textarea>
                        </div>

                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-warning">Güncelle</button>
                </div>

            </form>

        </div>
    </div>
</div>





@section Scripts {
    <script>

        $(document).ready(function () {

            // 🔥 CORS ATMAYAN DATATABLES
            const table = $('#musteriTable').DataTable({
                order: [[8, 'desc']],
                language: {
                    search: "Firma Ara:",
                    searchPlaceholder: "Firma adı yazın..."
                },
                responsive: true,
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tümü"]],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                columnDefs: [
                    { targets: [0], visible: false },
                    { targets: [10], orderable: false, searchable: false },
                    { targets: [4], orderable: false }
                ]
            });

            // Firma arama
            $.fn.dataTable.ext.search.push(function (settings, data) {
                var term = $('.dataTables_filter input').val().toLowerCase();
                if (!term) return true;
                return data[1].toLowerCase().includes(term);
            });

            // Filtreler
            $('#filterDurum').on('change', function () { table.column(6).search(this.value).draw(); });
            $('#filterTeknoloji').on('change', function () { table.column(5).search(this.value).draw(); });
            $('#filterTalep').on('change', function () { table.column(7).search(this.value).draw(); });

            // Müşteri seçme
            $(document).on('click', '#musteriTable tbody tr', function (e) {

                if ($(e.target).closest('button').length) return;

                const id = $(this).data('id');

                $('#musteriTable tr').removeClass('table-primary');
                $(this).addClass('table-primary');

                $('#selectedInfo').show().html(`<strong>Seçilen Müşteri:</strong> ${$(this).find('td:nth-child(2)').text()}`);

                   fetch(`/Detay/GetDetaylar?musteriId=${id}`)
        .then(r => r.text())
        .then(html => {
            $("#detayContainer").hide().html(html);

            // AJAX ile gelen scriptleri çalıştır
            var scripts = $(html).filter("script");
            scripts.each(function () {
                eval($(this).text());
            });

            $("#detayContainer").slideDown(250);
        });

            });

            // Düzenleme modal
            $(document).on('click', '.edit-btn', function (e) {
                e.stopPropagation();
                const id = $(this).closest('tr').data('id');

                fetch(`/Detay/GetMusteri?id=${id}`)
                    .then(r => r.json())
                    .then(m => {
                        $('#editMusteriId').val(m.musteriID);
                        $('#editFirma').val(m.firma);
                        $('#editFirmaYetkilisi').val(m.firmaYetkilisi);
                        $('#editTelefon').val(m.telefon);
                        $('#editSiteUrl').val(m.siteUrl);
                        $('#editTeknoloji').val(m.teknoloji);
                        $('#editDurum').val(m.durum);
                        $('#editTalepSahibi').val(m.talepSahibi);
                        $('#editAciklama').val(m.aciklama);

                        $('#editMusteriModal').modal('show');
                    });
            });

            // Düzenleme submit
            $('#editMusteriForm').submit(function (e) {
                e.preventDefault();
                const formData = new FormData(this);

                fetch('/Detay/UpdateMusteri', {
                    method: 'POST',
                    body: formData
                })
                .then(r => r.json())
                .then(d => {
                    alert(d.message);
                    if (d.success) location.reload();
                });
            });

            // Silme
            $(document).on('click', '.delete-btn', function (e) {
                e.stopPropagation();
                const tr = $(this).closest('tr');
                const id = tr.data('id');

                if (confirm("Silinsin mi?")) {
                    fetch(`/Detay/DeleteMusteri/${id}`, { method: 'DELETE' })
                        .then(r => r.json())
                        .then(d => {
                            alert(d.message);
                            if (d.success) table.row(tr).remove().draw();
                        });
                }
            });

        });

    </script>
}

