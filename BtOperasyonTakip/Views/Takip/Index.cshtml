@model BtOperasyonTakip.Models.JiraBoardViewModel
@{
    ViewData["Title"] = "İş Takip";

    var beklemedeCount = Model?.Beklemede?.Count ?? 0;
    var aktifCount = Model?.Aktif?.Count ?? 0;
    var tamamlandiCount = Model?.Tamamlandi?.Count ?? 0;
    var totalCount = beklemedeCount + aktifCount + tamamlandiCount;
}

<div class="container py-2">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
        <div>
            <h4 class="mb-1">İş Takip</h4>
            <div class="text-muted small">Toplam: <strong>@totalCount</strong> iş</div>
        </div>

        <div class="d-flex flex-wrap gap-2">
            <span class="badge rounded-pill text-bg-secondary">Beklemede: @beklemedeCount</span>
            <span class="badge rounded-pill text-bg-primary">Aktif: @aktifCount</span>
            <span class="badge rounded-pill text-bg-success">Tamamlandı: @tamamlandiCount</span>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div class="fw-semibold">İş Ekle</div>
                <div class="text-muted small">Durum varsayılan: Beklemede</div>
            </div>
        </div>
        <div class="card-body">
            <form asp-controller="Takip" asp-action="Create" method="post">
                @Html.AntiForgeryToken()
                <div class="row g-2">
                    <div class="col-md-2">
                        <label class="form-label">İş Adı</label>
                        <input name="JiraId" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Talep Konusu</label>
                        <input name="TalepKonusu" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Talep Açan</label>
                        <input name="TalepAcan" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Takip Eden</label>
                        <input name="TakipEden" class="form-control" />
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Ekle</button>
                    <button type="reset" class="btn btn-outline-secondary">Sıfırla</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row align-items-end g-2">
                <div class="col-md-6">
                    <label for="taskSearch" class="form-label">Ara</label>
                    <input id="taskSearch" type="text" class="form-control" placeholder="JiraId / Konu / Açan / Takip Eden..." autocomplete="off" />
                </div>

                <div class="col-md-6 d-flex justify-content-md-end gap-2 flex-wrap">
                    <div class="d-flex flex-column align-items-md-end">
                        <label for="boardStatusFilter" class="form-label mb-1">Kolon Filtre</label>
                        <select id="boardStatusFilter" class="form-select form-select-sm" style="width:auto">
                            <option value="all" selected>Tümü</option>
                            <option value="Beklemede">Beklemede</option>
                            <option value="Aktif">Aktif</option>
                            <option value="Tamamlandı">Tamamlandı</option>
                        </select>
                    </div>

                    <button type="button" id="taskSearchClear" class="btn btn-outline-secondary align-self-end">Temizle</button>
                    <div class="text-muted align-self-end small">
                        Eşleşen: <span id="taskSearchCount">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3" id="board">
        <div class="col-md-4 board-col" data-status-col="Beklemede">
            <div class="board-col-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <h5 class="mb-0">Beklemede</h5>
                    <span class="badge text-bg-secondary board-col-count" data-count-for="Beklemede">@beklemedeCount</span>
                </div>
                <select class="form-select form-select-sm board-col-status" style="width:auto" aria-label="Kolon seç">
                    <option value="Beklemede" selected>Beklemede</option>
                    <option value="Aktif">Aktif</option>
                    <option value="Tamamlandı">Tamamlandı</option>
                </select>
            </div>

            <div class="dropzone mt-2" data-status="Beklemede">
                @foreach (var t in Model.Beklemede)
                {
                    <div class="card mb-2 draggable task-card status-beklemede" draggable="true" data-id="@t.Id">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start gap-2">
                                <div class="fw-bold">@t.TalepKonusu</div>
                                <span class="badge text-bg-light border">@t.JiraId</span>
                            </div>

                            <div class="small text-muted mt-1">Açan: @t.TalepAcan</div>
                            <div class="small text-muted">Takip Eden: <span class="takip-eden-text">@(string.IsNullOrWhiteSpace(t.TakipEden) ? "-" : t.TakipEden)</span></div>

                            <div class="small text-muted d-flex align-items-center gap-2 mt-2">
                                <span>Durum:</span>
                                <select class="form-select form-select-sm task-status" style="width:auto" data-id="@t.Id">
                                    <option value="Beklemede" selected="@(t.Durum?.Trim().Equals("Beklemede", StringComparison.OrdinalIgnoreCase) == true)">Beklemede</option>
                                    <option value="Aktif" selected="@(t.Durum?.Trim().Equals("Aktif", StringComparison.OrdinalIgnoreCase) == true)">Aktif</option>
                                    <option value="Tamamlandı" selected="@(t.Durum?.Trim().Equals("Tamamlandı", StringComparison.OrdinalIgnoreCase) == true)">Tamamlandı</option>
                                </select>
                                <span class="small task-status-msg text-muted"></span>
                            </div>

                            <div class="mt-2 d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary btn-detay">Detay</button>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-sil">Sil</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="col-md-4 board-col" data-status-col="Aktif">
            <div class="board-col-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <h5 class="mb-0">Aktif</h5>
                    <span class="badge text-bg-primary board-col-count" data-count-for="Aktif">@aktifCount</span>
                </div>
                <select class="form-select form-select-sm board-col-status" style="width:auto" aria-label="Kolon seç">
                    <option value="Beklemede">Beklemede</option>
                    <option value="Aktif" selected>Aktif</option>
                    <option value="Tamamlandı">Tamamlandı</option>
                </select>
            </div>

            <div class="dropzone mt-2" data-status="Aktif">
                @foreach (var t in Model.Aktif)
                {
                    <div class="card mb-2 draggable task-card status-aktif" draggable="true" data-id="@t.Id">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start gap-2">
                                <div class="fw-bold">@t.TalepKonusu</div>
                                <span class="badge text-bg-light border">@t.JiraId</span>
                            </div>

                            <div class="small text-muted mt-1">Açan: @t.TalepAcan</div>
                            <div class="small text-muted">Takip Eden: <span class="takip-eden-text">@(string.IsNullOrWhiteSpace(t.TakipEden) ? "-" : t.TakipEden)</span></div>

                            <div class="small text-muted d-flex align-items-center gap-2 mt-2">
                                <span>Durum:</span>
                                <select class="form-select form-select-sm task-status" style="width:auto" data-id="@t.Id">
                                    <option value="Beklemede" selected="@(t.Durum?.Trim().Equals("Beklemede", StringComparison.OrdinalIgnoreCase) == true)">Beklemede</option>
                                    <option value="Aktif" selected="@(t.Durum?.Trim().Equals("Aktif", StringComparison.OrdinalIgnoreCase) == true)">Aktif</option>
                                    <option value="Tamamlandı" selected="@(t.Durum?.Trim().Equals("Tamamlandı", StringComparison.OrdinalIgnoreCase) == true)">Tamamlandı</option>
                                </select>
                                <span class="small task-status-msg text-muted"></span>
                            </div>

                            <div class="mt-2 d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary btn-detay">Detay</button>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-sil">Sil</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="col-md-4 board-col" data-status-col="Tamamlandı">
            <div class="board-col-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <h5 class="mb-0">Tamamlandı</h5>
                    <span class="badge text-bg-success board-col-count" data-count-for="Tamamlandı">@tamamlandiCount</span>
                </div>
                <select class="form-select form-select-sm board-col-status" style="width:auto" aria-label="Kolon seç">
                    <option value="Beklemede">Beklemede</option>
                    <option value="Aktif">Aktif</option>
                    <option value="Tamamlandı" selected>Tamamlandı</option>
                </select>
            </div>

            <div class="dropzone mt-2" data-status="Tamamlandı">
                @foreach (var t in Model.Tamamlandi)
                {
                    <div class="card mb-2 draggable task-card status-tamamlandi" draggable="true" data-id="@t.Id">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start gap-2">
                                <div class="fw-bold">@t.TalepKonusu</div>
                                <span class="badge text-bg-light border">@t.JiraId</span>
                            </div>

                            <div class="small text-muted mt-1">Açan: @t.TalepAcan</div>
                            <div class="small text-muted">Takip Eden: <span class="takip-eden-text">@(string.IsNullOrWhiteSpace(t.TakipEden) ? "-" : t.TakipEden)</span></div>

                            <div class="small text-muted d-flex align-items-center gap-2 mt-2">
                                <span>Durum:</span>
                                <select class="form-select form-select-sm task-status" style="width:auto" data-id="@t.Id">
                                    <option value="Beklemede" selected="@(t.Durum?.Trim().Equals("Beklemede", StringComparison.OrdinalIgnoreCase) == true)">Beklemede</option>
                                    <option value="Aktif" selected="@(t.Durum?.Trim().Equals("Aktif", StringComparison.OrdinalIgnoreCase) == true)">Aktif</option>
                                    <option value="Tamamlandı" selected="@(t.Durum?.Trim().Equals("Tamamlandı", StringComparison.OrdinalIgnoreCase) == true)">Tamamlandı</option>
                                </select>
                                <span class="small task-status-msg text-muted"></span>
                            </div>

                            <div class="mt-2 d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary btn-detay">Detay</button>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-sil">Sil</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ====== UI helpers ======
        function normalizeStatus(s) {
            return (s || '').trim();
        }

        function setCardStatusClass(card, yeniDurum) {
            if (!card) return;
            card.classList.remove('status-beklemede', 'status-aktif', 'status-tamamlandi');

            const st = normalizeStatus(yeniDurum);
            if (st === 'Beklemede') card.classList.add('status-beklemede');
            else if (st === 'Aktif') card.classList.add('status-aktif');
            else if (st === 'Tamamlandı') card.classList.add('status-tamamlandi');
        }

        function updateColumnCounts() {
            document.querySelectorAll('.board-col').forEach(col => {
                const status = col.getAttribute('data-status-col');
                const zone = col.querySelector('.dropzone');
                const count = zone ? zone.querySelectorAll('.task-card:not(.d-none)').length : 0;

                const badge = col.querySelector(`.board-col-count[data-count-for="${status}"]`);
                if (badge) badge.textContent = count.toString();
            });
        }

        // ====== Search / Filter (ARAMA ÇALIŞIR) ======
        function applyTaskSearchFilter() {
            const input = document.getElementById('taskSearch');
            const q = (input ? input.value : '').trim().toLocaleLowerCase('tr-TR');

            const cards = document.querySelectorAll('.task-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const text = (card.innerText || '').toLocaleLowerCase('tr-TR');
                const isMatch = !q || text.includes(q);
                card.classList.toggle('d-none', !isMatch);
                if (isMatch) visibleCount++;
            });

            const countEl = document.getElementById('taskSearchCount');
            if (countEl) countEl.textContent = visibleCount.toString();

            updateColumnCounts();
        }

        const taskSearchInput = document.getElementById('taskSearch');
        if (taskSearchInput) taskSearchInput.addEventListener('input', applyTaskSearchFilter);

        const taskSearchClear = document.getElementById('taskSearchClear');
        if (taskSearchClear) {
            taskSearchClear.addEventListener('click', () => {
                const input = document.getElementById('taskSearch');
                if (input) input.value = '';
                applyTaskSearchFilter();
                if (input) input.focus();
            });
        }

        // ====== Board column filter ======
        function layoutBoardColumns(selected) {
            const cols = Array.from(document.querySelectorAll('.board-col'));
            const isSingle = selected && selected !== 'all';

            cols.forEach(col => {
                col.classList.toggle('d-none', isSingle && col.getAttribute('data-status-col') !== selected);

                if (isSingle && col.getAttribute('data-status-col') === selected) {
                    col.classList.remove('col-md-4');
                    col.classList.add('col-md-12');
                } else {
                    col.classList.remove('col-md-12');
                    col.classList.add('col-md-4');
                }
            });
        }

        function applyBoardStatusFilter() {
            const sel = document.getElementById('boardStatusFilter');
            const val = sel ? sel.value : 'all';
            layoutBoardColumns(val);
            updateColumnCounts();
        }

        const boardStatusFilter = document.getElementById('boardStatusFilter');
        if (boardStatusFilter) {
            boardStatusFilter.addEventListener('change', () => {
                applyBoardStatusFilter();
                applyTaskSearchFilter();
            });
        }

        document.querySelectorAll('.board-col-status').forEach(s => {
            s.addEventListener('change', (e) => {
                const topFilter = document.getElementById('boardStatusFilter');
                if (topFilter) topFilter.value = e.currentTarget.value;
                applyBoardStatusFilter();
                applyTaskSearchFilter();
            });
        });

        // ====== Drag & Drop (SÜRÜKLEME ÇALIŞIR) ======
        let draggedCard = null;

        document.querySelectorAll('.draggable').forEach(card => {
            card.addEventListener('dragstart', (e) => {
                draggedCard = e.currentTarget;
                e.dataTransfer.effectAllowed = 'move';
                draggedCard.classList.add('opacity-50');
            });

            card.addEventListener('dragend', () => {
                if (draggedCard) draggedCard.classList.remove('opacity-50');
                draggedCard = null;
            });
        });

        document.querySelectorAll('.dropzone').forEach(zone => {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('border', 'border-primary', 'bg-light');
                e.dataTransfer.dropEffect = 'move';
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('border', 'border-primary', 'bg-light');
            });

            zone.addEventListener('drop', async (e) => {
                e.preventDefault();
                zone.classList.remove('border', 'border-primary', 'bg-light');
                if (!draggedCard) return;

                const id = parseInt(draggedCard.getAttribute('data-id'));
                const yeniDurum = zone.getAttribute('data-status');

                const oldParent = draggedCard.parentElement;
                zone.appendChild(draggedCard);

                // UI sync
                setCardStatusClass(draggedCard, yeniDurum);
                const sel = draggedCard.querySelector('.task-status');
                if (sel) sel.value = yeniDurum;

                try {
                    const resp = await fetch('@Url.Action("UpdateDurum", "Takip")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id, yeniDurum })
                    });

                    if (!resp.ok) throw new Error('HTTP ' + resp.status);

                    const data = await resp.json();
                    if (!data.success) {
                        oldParent.appendChild(draggedCard);
                        // rollback class & select to old parent's status
                        const oldStatus = oldParent ? oldParent.getAttribute('data-status') : null;
                        if (oldStatus) {
                            setCardStatusClass(draggedCard, oldStatus);
                            if (sel) sel.value = oldStatus;
                        }
                        alert('Durum güncellenemedi: ' + (data.message || 'Hata'));
                    } else {
                        applyTaskSearchFilter();
                    }
                } catch (err) {
                    oldParent.appendChild(draggedCard);
                    const oldStatus = oldParent ? oldParent.getAttribute('data-status') : null;
                    if (oldStatus) {
                        setCardStatusClass(draggedCard, oldStatus);
                        if (sel) sel.value = oldStatus;
                    }
                    alert('Durum güncellemede hata: ' + err);
                }
            });
        });

        // ====== Status dropdown change on card ======
        document.querySelectorAll('.task-status').forEach(sel => {
            sel.addEventListener('change', async (e) => {
                const select = e.currentTarget;
                const id = parseInt(select.getAttribute('data-id'));
                const yeniDurum = select.value;

                const card = select.closest('.task-card');
                const msg = card ? card.querySelector('.task-status-msg') : null;

                const oldZone = card ? card.closest('.dropzone') : null;
                const oldStatus = oldZone ? oldZone.getAttribute('data-status') : null;

                const targetZone = document.querySelector(`.dropzone[data-status="${yeniDurum}"]`);

                // UI: move first (rollback on error)
                if (card && targetZone && targetZone !== oldZone) {
                    targetZone.appendChild(card);
                    setCardStatusClass(card, yeniDurum);
                }

                if (msg) msg.textContent = 'Kaydediliyor...';

                try {
                    const resp = await fetch('@Url.Action("UpdateDurum", "Takip")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id, yeniDurum })
                    });

                    if (!resp.ok) throw new Error('HTTP ' + resp.status);

                    const data = await resp.json();
                    if (!data.success) throw new Error(data.message || 'Güncellenemedi');

                    if (msg) msg.textContent = '';
                    applyTaskSearchFilter();
                } catch (err) {
                    // rollback
                    if (card && oldZone) oldZone.appendChild(card);
                    if (oldStatus) {
                        select.value = oldStatus;
                        setCardStatusClass(card, oldStatus);
                    }
                    if (msg) msg.textContent = '';
                    alert('Durum güncellemede hata: ' + err);
                }
            });
        });

        // Initial
        applyBoardStatusFilter();
        applyTaskSearchFilter();
    </script>

    <style>
        .board-col-header {
            background: #fff;
            border: 1px solid rgba(0,0,0,.08);
            border-radius: .75rem;
            padding: .6rem .75rem;
        }

        .dropzone {
            min-height: 80px;
            border: 1px dashed rgba(0,0,0,.15);
            border-radius: .75rem;
            padding: .5rem;
            background: rgba(0,0,0,.02);
        }

        .task-card {
            border-radius: .75rem;
            border: 1px solid rgba(0,0,0,.08);
            box-shadow: 0 1px 8px rgba(0,0,0,.04);
            overflow: hidden;
        }

            .task-card .card-body {
                padding: .75rem;
            }

            /* Duruma göre sol şerit */
            .task-card.status-beklemede {
                border-left: 6px solid #6c757d;
            }

            .task-card.status-aktif {
                border-left: 6px solid #0d6efd;
            }

            .task-card.status-tamamlandi {
                border-left: 6px solid #198754;
            }

            .task-card.opacity-50 {
                opacity: .6 !important;
            }
    </style>
}