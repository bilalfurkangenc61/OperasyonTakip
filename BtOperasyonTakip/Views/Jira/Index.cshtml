@model BtOperasyonTakip.Models.JiraBoardViewModel
@{
    ViewData["Title"] = "🧩 Jira Kanban Görünüm";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
    /* CSS kodu aynı kalacak */
    body {
        background: #f4f6fb;
        font-family: 'Poppins',sans-serif;
    }

    .kanban-wrapper {
        display: flex;
        gap: 16px;
        padding: 12px;
        overflow-x: auto;
        overflow-y: hidden;
        height: calc(100vh - 210px);
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
    }

        .kanban-wrapper::-webkit-scrollbar {
            height: 10px
        }

        .kanban-wrapper::-webkit-scrollbar-thumb {
            background: #007bff55;
            border-radius: 6px
        }

    .kanban-col {
        flex: 0 0 380px;
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,.08);
        max-height: 100%;
    }

    .kanban-header {
        position: sticky;
        top: 0;
        z-index: 1;
        background: #fff;
        padding: .8rem 1rem;
        font-weight: 600;
        border-bottom: 1px solid #eee;
    }

    .sortable-area {
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 12px
    }

        .sortable-area::-webkit-scrollbar {
            width: 8px
        }

        .sortable-area::-webkit-scrollbar-thumb {
            background: #9eb9ff66;
            border-radius: 5px
        }

    .kanban-card {
        background: #f8faff;
        border-left: 5px solid #0d6efd;
        border-radius: 10px;
        padding: .8rem;
        margin-bottom: 10px;
        cursor: grab;
        transition: .2s;
        position: relative;
    }

        .kanban-card:hover {
            transform: translateY(-2px);
            background: #eef5ff
        }

    .delete-btn {
        position: absolute;
        top: 6px;
        right: 10px;
        color: #dc3545;
        cursor: pointer
    }

    .drag-shadow {
        opacity: .7
    }

    .dragging {
        cursor: grabbing !important;
        transform: scale(1.02)
    }

    .card-detail {
        border-left: 3px solid #0d6efd;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,.06);
        margin: -2px 0 10px 0;
        padding: .75rem .9rem;
        animation: fadeIn .15s ease;
    }

    @@keyframes fadeIn {
        from {
            opacity: .5;
            transform: translateY(-4px)
        }

        to {
            opacity: 1;
            transform: none
        }
    }
</style>

<div class="container-fluid mt-3">
    <h3 class="text-primary mb-3">🧾 Jira Tarzı İş Takip Sistemi</h3>

    <!-- Form kısmı aynı -->
    <form asp-action="Create" method="post" class="row g-3 bg-light p-3 rounded shadow-sm mb-3">
        <div class="col-md-2"><input name="JiraId" class="form-control" placeholder="JIRA-101" required /></div>
        <div class="col-md-3"><input name="TalepKonusu" class="form-control" placeholder="Talep Konusu" required /></div>
        <div class="col-md-2"><input name="TalepAcan" class="form-control" placeholder="Talep Açan" required /></div>
        <div class="col-md-2">
            <select name="Durum" class="form-select">
                <option>Beklemede</option>
                <option>Aktif</option>
                <option>Tamamlandı</option>
            </select>
        </div>
        <div class="col-md-2"><button class="btn btn-success w-100">💾 Ekle</button></div>
    </form>

    <!-- Kanban board aynı -->
    <div class="kanban-wrapper" id="board">
        @foreach (var durum in new[] { "Beklemede", "Aktif", "Tamamlandı" })
        {
            var list = durum switch
            {
                "Beklemede" => Model.Beklemede,
                "Aktif" => Model.Aktif,
                "Tamamlandı" => Model.Tamamlandi,
                _ => new List<BtOperasyonTakip.Models.JiraTask>()
            };
            <div class="kanban-col" data-durum="@durum">
                <div class="kanban-header @(durum == "Beklemede" ? "text-warning" : durum == "Aktif" ? "text-success" : "text-secondary")">
                    @(durum == "Beklemede" ? "📋 Beklemede" : durum == "Aktif" ? "🚀 Aktif" : "✅ Tamamlandı")
                </div>
                <div class="sortable-area" data-durum="@durum">
                    @foreach (var t in list)
                    {
                        <div class="kanban-card" data-id="@t.Id">
                            <span class="delete-btn" title="Sil">✖</span>
                            <strong>@t.JiraId</strong> — @t.TalepKonusu<br />
                            <small>👤 @t.TalepAcan | 🕓 @t.OlusturmaTarihi.ToString("dd.MM.yyyy")</small>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>
@section Scripts {
    <script>
        $(document).ready(function () {
            // DEBUG: Sayfa yüklendiğinde kontrol
            console.log('🟢 Jira Sayfası Yüklendi');

            // Silme işlemi
            $(document).on('click', '.delete-btn', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const taskId = $(this).closest('.kanban-card').data('id');

                if (confirm('Bu taskı silmek istediğinizden emin misiniz?')) {
                    $.ajax({
                        url: '/Jira/Delete',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ Id: taskId }),
                        success: function(data) {
                            if (data.success) {
                                alert('Task silindi!');
                                location.reload();
                            } else {
                                alert('Hata: ' + data.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Delete error:', xhr.responseText);
                            alert('Task silinirken bir hata oluştu!');
                        }
                    });
                }
            });

            // SÜRÜKLE-BIRAK - DEBUG MOD
            $('.sortable-area').each(function() {
                const sortableArea = this;

                new Sortable(sortableArea, {
                    group: 'shared',
                    animation: 150,
                    ghostClass: 'drag-shadow',
                    dragClass: 'dragging',
                    onEnd: function(evt) {
                        console.log('=== SÜRÜKLE BIRAK DEBUG ===');

                        const taskId = parseInt(evt.item.getAttribute('data-id'));
                        const newStatus = evt.to.closest('.kanban-col').getAttribute('data-durum');

                        console.log('🔵 Task ID:', taskId, 'Type:', typeof taskId);
                        console.log('🔵 Yeni Durum:', newStatus, 'Type:', typeof newStatus);

                        // Validasyon
                        if (isNaN(taskId) || taskId <= 0) {
                            console.error('❌ Geçersiz Task ID');
                            alert('Geçersiz Task ID!');
                            return;
                        }

                        if (!newStatus) {
                            console.error('❌ Geçersiz durum');
                            alert('Geçersiz durum!');
                            return;
                        }

                        console.log('🔵 Gönderilecek veri:', { Id: taskId, YeniDurum: newStatus });

                        // AJAX isteği
                        $.ajax({
                            url: '/Jira/UpdateDurum',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                Id: taskId,
                                YeniDurum: newStatus
                            }),
                            success: function(data, status, xhr) {
                                console.log('✅ AJAX Success:', data);
                                console.log('✅ Status:', status);
                                if (data.success) {
                                    console.log('✅ Durum güncellendi!');
                                    // Başarılı - sessizce devam et
                                } else {
                                    console.error('❌ Server hatası:', data.message);
                                    alert('Hata: ' + data.message);
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('❌ AJAX Error:', error);
                                console.error('❌ Status:', status);
                                console.error('❌ XHR Response:', xhr.responseText);
                                console.error('❌ XHR Status:', xhr.status);

                                alert('Sunucu hatası! Konsolu kontrol edin.');
                            },
                            complete: function(xhr, status) {
                                console.log('✅ AJAX Complete. Status:', status);
                            }
                        });
                    }
                });
            });

            // Kart detayı
            $(document).on('click', '.kanban-card', function(e) {
                if ($(e.target).hasClass('delete-btn')) return;

                const taskId = $(this).data('id');
                const detailCard = $(this).next('.card-detail');

                if (detailCard.length > 0) {
                    detailCard.slideUp(200, function() {
                        $(this).remove();
                    });
                } else {
                    $('.card-detail').remove();

                    $.get(`/Jira/DetailCard?id=${taskId}`)
                        .done(function(html) {
                            $(this).after(`<div class="card-detail">${html}</div>`);
                            $('.card-detail').hide().slideDown(200);
                        }.bind(this))
                        .fail(function() {
                            alert('Detaylar yüklenemedi.');
                        });
                }
            });
        });
    </script>
}